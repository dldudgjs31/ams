<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/template}">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
<title>Table - Brand</title>
<script>

</script>
<script th:src="@{/js/colorpicker/spectrum.min.js}"></script>
<link rel="stylesheet" type="text/css" th:href="@{/js/colorpicker/spectrum.min.css}"/>

<style type="text/css">
.tooltip{
    font-family: 'Jua', sans-serif;
}

/* 학생 리스트 스타일 반영 */
.studentlists{
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    color:white; 
}
</style>
<script th:inline="javascript">
    function deletebtn(value){
        var student=$('button[value='+value+']').text();
        if(confirm(student+"을 해당 클래스에서 삭제하시겠습니까?")){
            $('button[value='+value+']').parent('div').remove();
            $("select#selected-student option[value="+value+"]").remove();
        }
    }
$(function(){
    function getContextPath() {
        var hostIndex = location.href.indexOf( location.host ) + location.host.length;
        return location.href.substring( hostIndex, location.href.indexOf("/", hostIndex + 1) );
    };
    /*<![CDATA[*/
        //colorpicker 라이브러리 초기화
    $("#colorpicker").spectrum({
        color: [[${class.c_color}]]
    });
    alert([[${class.c_wkd}]]);
    $("select#c_wkd option[value="+[[${class.c_wkd}]]+"]").attr("selected","selected");


    /*]]>*/

    // tooltip 사용시 로딩
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    
    $('#endtime').blur(function(){
        var test = $('#endtime').val();
        var test1 = $('#starttime').val();
        var h2= test1.split(':');
        var h = test.split(':');
        //alert(parseInt(h[0])-parseInt(h2[0]));
    });
    
    // 원생 조회 버튼 기능
    $('#searchbtn').click(function(){
        $('#searchstudent').modal('show');
        
    });

    //조회-원생 정보 조회 버튼 클릭시
    //원생 이름, 나이, 학교조회 기능 
    $('#searchstudentbtn').click(function(){
        loading();
        $('#mask').show();
        let data ={
            st_nm: $('#studentname').val(),
            st_schl: $('#studentschl option:selected').val()=="" ? null:$('#studentschl option:selected').val(),
            age_min: $('#studentagefrom option:selected').val()=="" ? null:$('#studentagefrom option:selected').val(),
            age_max: $('#studentageto option:selected').val()=="" ? null:$('#studentageto option:selected').val(),
        }
        $.ajax({
            type: "POST", 
            url: getContextPath()+"/class/studentlist",
            data: JSON.stringify(data),
            contentType:"application/json;charset=utf-8",
            dataType:"json" 
        }).done(function(resp){
            //기존의 조회된 내역 제거
            $('#mask').hide();
            $('#searched-student').empty();
            for(var i=0; i<resp.data.length; i++){
                var gender = resp.data[i].st_gen=='M'? '(남)':'(여)';
                var classnm = resp.data[i].c_nm !=null ? '['+resp.data[i].c_nm+']' : "";
                var option = $("<option value='"+resp.data[i].st_idx+"'>"+resp.data[i].st_nm+gender+" "+resp.data[i].st_bth+"살 "+resp.data[i].st_schl+" "+classnm +"</option>");
                $("#searched-student").append(option);
            }


        }).fail(function(error){
            $('#mask').hide();
            alert("조회 실패");
        });     
    });
    



    // 선택한 학생을 확정란으로 옮기기 
    $('#searched-student').mouseup(function(){
        var selectVal = $("#searched-student option:selected").val();
        var selectText =  $("#searched-student option:selected").text();
        //$("#multiple option:selected").attr("disabled",true);
        //$("#multiple option:selected").css("background-color","darkslategray");
        $("select#searched-student option[value="+selectVal+"]").remove();
        var option = $("<option value='"+selectVal+"'>"+selectText+"</option>");

        //이미 선택된 학생인지 확인
        var len = $("#selected-student").children().length;
        for(var i=0;i<len;i++){
            var st_idx = $("#selected-student").children().eq(i).val();
            if(selectVal ==st_idx){
                return alert("이미 선택된 학생입니다.");
            }
        }
        $("#selected-student").append(option);
        $("select#searched-student option[value="+"undefined"+"]").remove();
        $("select#selected-student option[value="+"undefined"+"]").remove();
    });

    //선택된 학생들 취소 옮기기
    $('#selected-student').mouseup(function(){
        var selectVal = $("#selected-student option:selected").val();
        var selectText =  $("#selected-student option:selected").text();
        //$("#multiple option:selected").attr("disabled",true);
        //$("#multiple option:selected").css("background-color","darkslategray");
        $("select#selected-student option[value="+selectVal+"]").remove();
        $('button[value='+selectVal+']').parent('div').remove();
        var option = $("<option value='"+selectVal+"'>"+selectText+"</option>");
        $("#searched-student").append(option);
        $("select#searched-student option[value="+"undefined"+"]").remove();
        $("select#selected-student option[value="+"undefined"+"]").remove();
    });


    //조회에서 선택된 학생들 확정 등록
    $(document).on("click","button[name='add']",function(){
        for(var i=0;i<$("#selected-student").children().length;i++){
            var info = $("#selected-student").children().eq(i).text();
            var column = $('<div class="col-sm-4 col-lg-3 add-student"  style="padding-bottom: 10px;">');
            var studentbtn = $('<button type="button" class="btn btn-info studentlists" onclick="deletebtn('+$("#selected-student").children().eq(i).val()+')" value='+$("#selected-student").children().eq(i).val()+'>'+info+'<i class="fa-solid fa-xmark"></i></button>');
            column.append(studentbtn);
            $('#student-div').append(column);
        }
        $('#searchstudent').modal('hide');
    });
    // $('#student-register').click(function(){
    //  for(var i=0;i<$("#selected-student").children().length;i++){
    //      var info = $("#selected-student").children().eq(i).text();
    //      var column = $('<div class="col-sm-4 col-lg-3 add-student"  style="padding-bottom: 10px;">');
    //      var studentbtn = $('<button type="button" class="btn btn-info studentlists" value='+$("#selected-student").children().eq(i).val()+'>'+info+'<i class="fa-solid fa-xmark"></i></button>');
    //      column.append(studentbtn);
    //      $('#student-div').append(column);
    //  }
    //  $('#searchstudent').modal('hide');
        
    // });


    

    $("#submit").click(function(){
        alert("유효성검사 필요!");
        var len = $("#selected-student").children().length;
        let student = [];
        for (var i = 0; i < len; i++) {
            var st_idx = $("#selected-student").children().eq(i).val();
            student.push(st_idx);
        }
        alert(student);
        let data = {
            c_nm: $('#c_nm').val(),
            c_color: $('#colorpicker').val(),
            c_cap: $('#c_cap').val(),
            t_idx: $('select#t_idx option:selected').val(),
            c_detail: $('#c_detail').val(),
            c_st_tm: $('#c_st_tm').val(),
            c_ed_tm: $('#c_ed_tm').val(),
            c_wkd: $('select#c_wkd option:selected').val(),
            st_idx: student
        }

        /*<![CDATA[*/
        var c_idx = [[${class.c_idx}]];

        /*]]>*/
        alert(c_idx);
        $.ajax({
            type: "PUT",
            url: getContextPath() + "/class/" + c_idx,
            data: JSON.stringify(data),
            contentType: "application/json;charset=utf-8",
            dataType: "json"
        }).done(function (resp) {
            alert("클래스 수정 완료");
            location.href = getContextPath() + "/class/all";
        }).fail(function (error) {
            alert("클래스 수정 실패");
        });         
    });


});

</script>

</head>

<div class="container-fluid" layout:fragment="content">



    <h3 class="text-dark mb-4">클래스 수정</h3>
    <div class="row">
        <div class="col">
            <div class="row">
                <div class="col">
                    <div class="card shadow mb-3">
                        <div class="card-header py-3">
                            <p class="text-primary m-0 fw-bold">클래스 상세</p>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col">
                                    <div class="mb-3">
                                        <label class="form-label" for="username"><strong >클래스명</strong></label><input id="c_nm" class="form-control" type="text" placeholder="클래스명" th:value="${class.c_nm}" name="c_nm" />
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="mb-3">
                                        <label class="form-label" for="first_name"><strong data-bs-toggle="tooltip" data-bs-placement="right" title="클래스 / 캘린더 목록 컬러">클래스 표시 컬러</strong><br/></label><input id="colorpicker" class="form-control"  name="c_color" />
                                    </div>

                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="mb-3">
                                        <label class="form-label" for="first_name"><strong>클래스 허용 인원</strong><br /></label><input id="c_cap" class="form-control" type="number" th:value="${class.c_cap}" placeholder="0" name="c_cap" />
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="mb-3">
                                        <label class="form-label" for="last_name"><strong>담당 선생님</strong><br /></label> <select class="form-select form-control" id="t_idx" aria-label="Default select example" name="t_idx">
                                            <th:block th:each="teacher : ${list}">
                                                <option th:if="${teacher.t_idx == class.t_idx}" th:text="${teacher.t_name}" th:value="${teacher.t_idx}" selected>Open this select menu</option>
                                                <option th:unless="${teacher.t_idx == class.t_idx}" th:text="${teacher.t_name}" th:value="${teacher.t_idx}">Open this select menu</option>
                                            </th:block>
                                        </select>

                                    </div>

                                </div>
                            </div>
                            <div class="row">
                                <div class="mb-3">
                                    <label class="form-label" for="c_detail"><strong>클래스 설명</strong></label>
                                    <textarea class="form-control" id="c_detail" rows="4" name="c_detail" th:text="${class.c_detail}" ></textarea>
                                </div>
                            </div>
                            <div class="mb-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card shadow mb-3">
            <div class="card-header py-3">
                <p class="text-primary m-0 fw-bold">클래스 시간대</p>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <label class="form-label" for="username"><strong>클래스 시작 시간</strong><br /></label><input id="c_st_tm" class="form-control" type="time"  name="c_st_tm" th:value="${class.c_st_tm}" />
                        </div>
                    </div>
                    <div class="col">
                        <div class="mb-3">
                            <label class="form-label" for="email"><strong>클래스 종료 시간</strong></label><input id="c_ed_tm" class="form-control" type="time"  name="c_ed_tm" th:value="${class.c_ed_tm}"/>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <label class="form-label" for="first_name"><strong>클래스 요일</strong><br /></label>
                            <select class="form-select form-control" id="c_wkd" aria-label="Default select example" name="c_wkd">
                                <option value="2">월요일</option>
                                <option value="3">화요일</option>
                                <option value="4">수요일</option>
                                <option value="5">목요일</option>
                                <option value="6">금요일</option>
                                <option value="7">토요일</option>
                                <option value="1">일요일</option>
                              </select>
                        </div>
                    </div>
                    <div class="col">
                    </div>
                </div>
                <div class="mb-3"></div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card shadow mb-3">
            <div class="card-header py-3">
                <p class="text-primary m-0 fw-bold">클래스 원생 등록</p>
            </div>
            <div class="card-body">
                <div class="row" style="padding-bottom: 10px;">
                    <div class="col">
                        <label class="form-label" for="username"><strong>원생 리스트</strong> 
                            &nbsp;&nbsp;&nbsp;
                            <button type="button" id="searchbtn" class="btn btn-primary" style="color: white;">원생조회&nbsp;<i class="fa-solid fa-magnifying-glass"></i></button><br /></label>
                    </div>
                </div>
                <div class="row" style="padding-bottom: 10px;" id="student-div">
                    <th:block th:each="student : ${class.st_list}">
                        <div class="col-sm-4 col-lg-3 add-student"  style="padding-bottom: 10px;">
                            <button type="button" class="btn btn-info studentlists" th:onclick="'javascript:deletebtn('+ ${student.st_idx} + ');'" th:value="${student.st_idx}">[[${student.st_nm}]][[${#strings.toString(student.st_gen)}=='M' ? '(남) ':'(여) ']] [[${student.st_bth}+'살']] [[${student.st_schl}]]<i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </th:block>
                </div>
                <br/><br/><br/>
            <div class="row">
                    <button type="button" id="submit" class="btn btn-primary">클래스 수정 완료</button>
            </div>
            </div>
            
        </div>
    </div>

    <!-- 모달창(원생조회) -->
    <div class="modal" id="searchstudent" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">원생조회</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <!-- 조건1 이름 -->
                <div class="col-sm-6 col-lg-3">
                    <div class="input-group input-group mb-3">
                        <span class="input-group-text" id="inputGroup-sizing-sm">이름</span>
                        <input type="text" class="form-control" id="studentname" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
                      </div>    
                </div>
                <!-- 조건2 학교 -->
                <div class="col-sm-6 col-lg-3">
                    <div class="input-group input-group mb-3">
                    <span class="input-group-text" id="inputGroup-sizing-sm">학교</span>
                    <select class="form-select" id="studentschl" aria-label="Default select example">
                        <option value="">[학교 선택]</option>
                        <th:block th:each="student : ${list3}">
                                <option th:if="${not #strings.isEmpty(student.st_schl)}" th:text="${student.st_schl}" th:value="${student.st_schl}">학교</option>
                        </th:block>
                    </select>
                    </div>
                </div>
                <!-- 조건3 나이 -->
                <div class="col-sm-6 col-lg-5">
                    <div class="input-group input-group mb-3">
                    <span class="input-group-text" id="inputGroup-sizing-sm">나이</span>
                    <select class="form-select" id="studentagefrom" aria-label="Default select example">
                        <option value="">[선택]</option>
                        <th:block th:each="num : ${#numbers.sequence(min,max)}">
                                <option th:text="${num}+'살'" th:value="${num}">학교</option>
                        </th:block>
                    </select>
                    <span class="input-group-text" id="inputGroup-sizing-sm">to</span>
                    <select class="form-select" id="studentageto" aria-label="Default select example">
                        <option value="">[선택]</option>
                        <th:block th:each="num : ${#numbers.sequence(min,max)}">
                                <option th:text="${num}+'살'" th:value="${num}">학교</option>
                        </th:block>
                    </select>
                    </div>
                </div>
                <div class="col-sm-3 col-lg-1">
                    <button type="button" id="searchstudentbtn" class="btn btn-info" style="color: white;">조회</button>
                </div>

                </div>
                
                <div class="row  align-items-center">
                    
                    <div class="col-sm-12 col-lg-6">
                        <h6>조회된 원생 리스트</h6>
                    <select class="form-select form-control" id="searched-student" th:size="${#lists.size(list2)}" aria-label="select example" style="height: 300px;">
                        <!-- <th:block th:each="student : ${list2}">
                            <option th:text="${student.st_nm}+'('+${#strings.toString(student.st_gen) == 'M'?'남':'여'}+') ' + ${student.st_bth} +'살'" th:value="${student.st_idx}">Open this select menu</option>
                        </th:block> -->
                      </select>
                      </select>
                    </div>
    
                    <div class="col-sm-12 col-lg-6">
                        <h6>등록할 원생 리스트</h6>
                        <select class="form-select form-control" id="selected-student" th:size="${#lists.size(list2)}" aria-label="select example" style="height: 300px;">
                        <th:block th:each="student : ${class.st_list}">
                            <option th:text="${student.st_nm}+'('+${#strings.toString(student.st_gen) == 'M'?'남':'여'}+') ' + ${student.st_bth} +'살'" th:value="${student.st_idx}">Open this select menu</option>
                        </th:block> 
                          </select>
                    </div>
                </div>

            </div>
            

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
              <button type="button" class="btn btn-primary" id="student-register" name="add">원생 등록</button>
            </div>
        </div>
    </div>
</div>

</div> <!-- end line -->

</html>
